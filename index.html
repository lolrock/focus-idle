<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Focus Idle</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,system-ui}
button{background:#111;color:#fff;border:1px solid #333;padding:10px;border-radius:8px}
button:disabled{opacity:.3}
.panel{padding:12px}
.row{margin-bottom:12px}
.small{color:#aaa;font-size:12px}
.log{height:180px;overflow:auto;border:1px solid #333;padding:8px;font-size:13px}
</style>
</head>
<body>

<div class="panel">
  <div id="status"></div>
  <div style="font-size:32px" id="points">0</div>

  <button id="btnGrow">집중하기</button>
  <button id="btnBattle">전투</button>
  <button id="btnUpgrade">업그레이드</button>
</div>

<div class="panel" id="upgrade" style="display:none">
  <h3>통합 스탯</h3>
  <div id="uStats"></div>

  <h3>치명 / 관통</h3>
  <div id="uCrit"></div>

  <button onclick="hideUpgrade()">닫기</button>
</div>

<div class="panel" id="battle" style="display:none">
  <div id="bInfo"></div>
  <div>내 HP <span id="meHP"></span>%</div>
  <div>적 HP <span id="enHP"></span>%</div>
  <div class="log" id="log"></div>
  <button onclick="endBattle()">도망</button>
</div>

<script>
/* ====== STATE ====== */
const KEY="focus_idle_v4";
let S=JSON.parse(localStorage.getItem(KEY)||"null")||{
  points:0,
  atk:5,def:5,matk:5,mdef:5,
  crit:0, pen:0,
  bonusSpent:0,
  enemyLv:1,
  c0:5,
  growing:false,
  growAt:0
};

/* ====== UTIL ====== */
const save=()=>localStorage.setItem(KEY,JSON.stringify(S));
const fmt=n=>n>=1e6?`${(n/10**Math.floor(Math.log10(n))).toFixed(2)}e${Math.floor(Math.log10(n))}`:Math.floor(n);

/* ====== GROW ====== */
function currentC(){
  return S.c0+Math.floor((S.enemyLv-1)/3);
}
function settle(){
  const t=Math.floor((Date.now()-S.growAt)/1000);
  const gain=Math.floor(t*currentC());
  S.points+=gain;
  S.growing=false;
  save();render();
}
btnGrow.onclick=()=>{
  if(S.growing) settle();
  else{S.growing=true;S.growAt=Date.now();}
};

/* ====== UPGRADE ====== */
btnUpgrade.onclick=()=>upgrade.style.display="block";
function hideUpgrade(){upgrade.style.display="none"}

function bonusCost(n){
  return 10*(2**(S.bonusSpent+n)-2**S.bonusSpent);
}

function buyBonus(stat,n){
  const cost=bonusCost(n);
  if(cost>S.points)return;
  S.points-=cost;
  S[stat]+=n;
  S.bonusSpent+=n;
  save();renderUpgrade();
}

function critCost(n,base){
  let c=0;
  for(let i=0;i<n;i++)c+=10*(2**(base+i));
  return c;
}

function buyCrit(n){
  const c=critCost(n,S.crit);
  if(c>S.points)return;
  S.points-=c;S.crit+=n;save();renderUpgrade();
}
function buyPen(n){
  const c=critCost(n,S.pen);
  if(c>S.points)return;
  S.points-=c;S.pen+=n;save();renderUpgrade();
}

function renderUpgrade(){
  uStats.innerHTML=["atk","def","matk","mdef"].map(s=>`
    <div>${s.toUpperCase()} ${S[s]}
    <button onclick="buyBonus('${s}',1)">+1</button>
    <button onclick="buyBonus('${s}',10)">+10</button>
    <button onclick="buyBonus('${s}',100)">+100</button>
    </div>`).join("");
  uCrit.innerHTML=`
    <div>CRIT ${S.crit}% 
      <button onclick="buyCrit(1)">+1</button>
      <button onclick="buyCrit(5)">+5</button>
    </div>
    <div>PEN ${S.pen}%
      <button onclick="buyPen(1)">+1</button>
      <button onclick="buyPen(5)">+5</button>
    </div>`;
}

/* ====== BATTLE ====== */
let battle=null,timer=null;

btnBattle.onclick=()=>{
  battle={
    meHP:maxHP(), enHP:enemyHP(),
    log:[]
  };
  battle.style.display="block";
  startBattle();
};

function maxHP(){
  return (S.atk+S.def+S.matk+S.mdef)*5;
}
function enemyHP(){
  return Math.floor(maxHP()*Math.pow(1.1,S.enemyLv-1));
}

function damage(atk,def){
  const effDef=Math.floor(def*(1-S.pen/100));
  let d=Math.max(1,atk-effDef);
  if(Math.random()*100<S.crit)d*=1.5;
  return Math.floor(d);
}

function turn(){
  battle.enHP-=damage(S.atk,S.def);
  battle.meHP-=damage(S.atk,S.def);
  battle.log.push("턴 진행");
  if(battle.enHP<=0){win();return}
  if(battle.meHP<=0){lose();return}
  renderBattle();
}

function startBattle(){
  renderBattle();
  timer=setInterval(turn,500);
}

function win(){
  clearInterval(timer);
  S.enemyLv++;
  save();
  endBattle();
}
function lose(){
  clearInterval(timer);
  endBattle();
}
function endBattle(){
  battle=null;
  battle.style.display="none";
  render();
}

function renderBattle(){
  meHP.textContent=Math.floor(battle.meHP/maxHP()*100);
  enHP.textContent=Math.floor(battle.enHP/enemyHP()*100);
  log.innerHTML=battle.log.slice(-10).join("<br>");
}

/* ====== RENDER ====== */
function render(){
  points.textContent=fmt(S.points);
  status.textContent=S.growing?"집중중":"대기";
}
render();
setInterval(render,1000);
</script>
</body>
</html>
